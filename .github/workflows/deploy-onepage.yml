name: Deploy ABC Explorer — OnePage Site

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  onepage:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cleanup
        run: |
          rm -rf * .github || true
          mkdir -p .github/workflows

      - name: Create content-pack.js (דמו רמות/יחידות/מילים)
        run: |
          cat > content-pack.js << 'EOF'
          window.ABC_CONTENT_PACK = {
            levels: ["A","B","C","D","E","F"],
            unitsPerLevel: 2,
            vocabPerUnit: 3,
            units: {
              A: { 1:["cat","dog","bird"], 2:["red","green","blue"] },
              B: { 1:["table","desk","chair"], 2:["sun","moon","star"] }
            }
          };
          EOF

      - name: Create profile.js (משתמש+הישגים)
        run: |
          cat > profile.js << 'EOF'
          window.PROFILE={
            username:"user",avatar:"avatar1.png",level:"A",xp:0,rewards:[]
          };
          EOF

      - name: Create avatars.js
        run: |
          cat > avatars.js << 'EOF'
          window.AVATARS=["avatar1.png","avatar2.png"];
          EOF

      - name: Create rewards.js (פרסים)
        run: |
          cat > rewards.js << 'EOF'
          window.REWARDS=[
            {id:"star",name:"⭐",desc:"כוכב זהב",price:10},
            {id:"bg1",name:"רקע יער",desc:"",price:15}
          ];
          EOF

      - name: Create games/memory.js
        run: |
          mkdir -p games
          cat > games/memory.js << 'EOF'
          window.GAMES=window.GAMES||{};
          window.GAMES.memory=function(level,unit){
            alert('🧠 Memory! מילים: '+window.ABC_CONTENT_PACK.units[level][unit].join(", "));
          }
          EOF

      - name: Create games/quiz.js
        run: |
          cat > games/quiz.js << 'EOF'
          window.GAMES=window.GAMES||{};
          window.GAMES.quiz=function(level,unit){
            alert('❓ Quiz - (דמו בלבד): מיליון תשובות?');
          }
          EOF

      - name: Create games/match.js
        run: |
          cat > games/match.js << 'EOF'
          window.GAMES=window.GAMES||{};
          window.GAMES.match=function(level,unit){
            alert('🎯 התאמה! (דמו).');
          }
          EOF

      - name: Create backup.js (גיבוי)
        run: |
          cat > backup.js << 'EOF'
          window.BACKUP={export:()=>JSON.stringify(window.PROFILE)};
          EOF

      - name: Create avatars images
        run: |
          wget https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png -O avatar1.png
          wget https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png -O avatar2.png

      - name: Create style.css
        run: |
          cat > style.css << 'EOF'
          body { background: #eff3ff; color: #1a1d22; font-family: Arial,sans-serif; }
          .main { max-width: 720px; margin: 40px auto; padding:32px; background:#fff; border-radius:16px; box-shadow:0 0 20px #dde;}
          h1 { color: #0563bb; text-align:center; margin-bottom:1em;}
          .avatar { border-radius:50%; width:90px; box-shadow:0 2px 8px #cdf;}
          .btn { background:#0563bb; color:#fff; padding:.7em 1.6em; border-radius:14px; font-weight:bold; border:none; margin:.5em; cursor:pointer;}
          .btn:active{background:#044c8b;}
          .unit-box { border:1px solid #cfd8dc; border-radius:8px; margin:1em 0; padding:.8em; }
          .reward {display:inline-block;padding:6px 16px; background:#f9fafb; margin:3px; border-radius:20px;}
          EOF

      - name: Create index.html
        run: |
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="he" dir="rtl">
          <head>
            <meta charset="UTF-8">
            <title>ABC Explorer - הכל בדף אחד</title>
            <link rel="stylesheet" href="style.css">
            <script src="content-pack.js"></script>
            <script src="profile.js"></script>
            <script src="avatars.js"></script>
            <script src="rewards.js"></script>
            <script src="games/memory.js"></script>
            <script src="games/quiz.js"></script>
            <script src="games/match.js"></script>
            <script src="backup.js"></script>
          </head>
          <body>
            <div class="main" id="main"></div>
            <script>
            function renderClasses(){
              let h='<h1>ABC Explorer — בחר כיתה</h1>';
              h+=window.ABC_CONTENT_PACK.levels.map(l=>
                `<button class='btn' onclick="startClass('${l}')">${l}</button>`
              ).join(' ');
              h+=`<hr><button class='btn' onclick='showProfile()'>🙍 פרופיל</button>`
              document.getElementById('main').innerHTML=h;
            }
            function startClass(l){
              let u=window.ABC_CONTENT_PACK.units[l];
              let html=`<h2>כיתה ${l} — בחר יחידת למידה</h2>`;
              for(let k in u){
                html+=`<div class='unit-box'><b>יחידה ${k}</b>: ${u[k].join(" , ")}<br>
                  <button class='btn' onclick="GAMES.memory('${l}','${k}')">🧠 Memory</button>
                  <button class='btn' onclick="GAMES.quiz('${l}','${k}')">❓ Quiz</button>
                  <button class='btn' onclick="GAMES.match('${l}','${k}')">🎯 התאמה</button>
                </div>`;
              }
              html+=`<button class='btn' onclick='renderClasses()'>חזור</button>`;
              document.getElementById('main').innerHTML=html;
            }
            function showProfile(){
              let h='<h2>פרופיל משתמש</h2>';
              h+=`<img class='avatar' src='${window.PROFILE.avatar}'>
                <div>שם: ${window.PROFILE.username}</div>
                <div>XP: ${window.PROFILE.xp}</div>
                <div>רמות: ${window.PROFILE.level}</div><hr>`;
              h+='<b>החלף אווטאר:</b><br>';
              window.AVATARS.forEach(im=> {
                h+=`<img src='${im}' width="60" class="avatar" style="margin:5px;cursor:pointer" onclick="setAvatar('${im}')">`
              });
              h+='<hr><b>פרסים שלי:</b><div>';
              window.PROFILE.rewards.forEach(rid=>{
                let r=window.REWARDS.find(x=>x.id==rid);
                h+=r?`<span class='reward'>${r.name}</span>`:'';
              });
              h+='</div><hr><h3>חנות פרסים</h3>';
              window.REWARDS.forEach(r=>{
                h+=`<div>${r.name} (${r.price} XP) <button class='btn' onclick="getReward('${r.id}')">קנה</button></div>`
              });
              h+=`<hr><button class='btn' onclick='renderClasses()'>דף כיתות</button>`;
              h+=`<button class='btn' onclick="alert(BACKUP.export())">📥 ייצוא פרופיל</button>`;
              document.getElementById('main').innerHTML=h;
            }
            function getReward(rid){
              let r=window.REWARDS.find(x=>x.id==rid);
              if(window.PROFILE.xp>=r.price){
                alert('קנית '+r.name);
                window.PROFILE.xp-=r.price;window.PROFILE.rewards.push(rid);showProfile();
              }else{
                alert('צריך עוד XP');
              }
            }
            function setAvatar(im){
              window.PROFILE.avatar=im; showProfile();
            }
            window.GAMES=window.GAMES||{};
            renderClasses();
            </script>
          </body>
          </html>
          EOF

      - name: Setup Github Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact for Github Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to Github Pages
        id: deploy
        uses: actions/deploy-pages@v4
